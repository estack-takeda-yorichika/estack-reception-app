<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å—ä»˜ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --primary: #2563EB;
      --primary-dark: #1D4ED8;
      --green: #10B981;
      --green-dark: #059669;
      --bg: #F1F5F9;
      --card: #FFFFFF;
      --text: #1E293B;
      --sub: #64748B;
      --border: #E2E8F0;
    }
    html, body {
      height: 100%;
      font-family: -apple-system, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
      background: var(--bg);
      overflow: hidden;
    }

    /* ===== ãƒšãƒ¼ã‚¸ç®¡ç† ===== */
    .page {
      display: none;
      position: fixed; inset: 0;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 32px;
      background: var(--bg);
    }
    .page.active { display: flex; }

    /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
    .home-header {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      white-space: nowrap;
    }
    .logo-img {
      height: 72px;
      width: auto;
      object-fit: contain;
      margin-bottom: 8px;
    }
    .logo-name {
      font-size: 38px;
      font-weight: 800;
      color: #1a1a1a;
      letter-spacing: 1px;
      margin-bottom: 0;
    }
    .welcome {
      font-size: 24px;
      color: var(--sub);
      margin-top: 16px;
      margin-bottom: 48px;
    }

    /* ===== ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ ===== */
    .main-btn {
      display: flex;
      align-items: center;
      gap: 28px;
      width: 100%;
      max-width: 520px;
      padding: 34px 36px;
      border: none;
      border-radius: 24px;
      margin-bottom: 20px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
      box-shadow: 0 6px 24px rgba(0,0,0,0.12);
    }
    .main-btn:active { transform: scale(0.96); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .btn-delivery { background: var(--primary); color: white; }
    .btn-visitor  { background: var(--green);   color: white; }
    .btn-icon  { font-size: 48px; flex-shrink: 0; }
    .btn-title { font-size: 24px; font-weight: 700; line-height: 1.2; }
    .btn-desc  { font-size: 14px; opacity: 0.85; margin-top: 4px; }

    /* ===== æˆ»ã‚‹ï¼è¨­å®šãƒœã‚¿ãƒ³ ===== */
    .back-btn, .settings-btn {
      position: fixed;
      top: 28px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 50%;
      width: 56px; height: 56px;
      font-size: 22px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      z-index: 100;
    }
    .back-btn     { left: 28px; }
    .settings-btn { right: 28px; }

    /* ===== ã‚µãƒ–é¸æŠãƒœã‚¿ãƒ³ ===== */
    .page-title { font-size: 26px; font-weight: 700; color: var(--text); margin-bottom: 8px; text-align: center; }
    .page-desc  { font-size: 16px; color: var(--sub); margin-bottom: 36px; text-align: center; }

    .sub-btn {
      display: flex;
      align-items: center;
      gap: 16px;
      width: 100%; max-width: 520px;
      padding: 22px 28px;
      border: 2px solid var(--border);
      border-radius: 16px;
      margin-bottom: 14px;
      background: white;
      cursor: pointer;
      font-size: 20px; font-weight: 600;
      color: var(--text);
      transition: all 0.12s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .sub-btn:active { background: #F1F5F9; transform: scale(0.97); }
    .sub-btn .si { font-size: 28px; }

    /* ===== æ‹…å½“è€…ãƒœã‚¿ãƒ³ ===== */
    .staff-btn {
      display: flex; align-items: center; justify-content: space-between;
      width: 100%; max-width: 520px;
      padding: 20px 28px;
      border: 2px solid var(--border);
      border-radius: 16px;
      margin-bottom: 14px;
      background: white;
      cursor: pointer;
      transition: all 0.12s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .staff-btn:active { background: #F1F5F9; transform: scale(0.97); }
    .staff-name { font-size: 20px; font-weight: 700; color: var(--text); }
    .staff-role { font-size: 14px; color: var(--sub); margin-top: 2px; }
    .staff-arrow { font-size: 24px; color: var(--sub); }

    /* ===== PINãƒ­ãƒƒã‚¯ ===== */
    .pin-wrap { width: 100%; max-width: 320px; text-align: center; }
    .pin-dots { display: flex; justify-content: center; gap: 16px; margin: 28px 0; }
    .pin-dot {
      width: 18px; height: 18px; border-radius: 50%;
      border: 2px solid var(--border); background: white;
      transition: background 0.15s;
    }
    .pin-dot.filled { background: var(--primary); border-color: var(--primary); }
    .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .pin-key {
      padding: 20px 0; border: 2px solid var(--border); border-radius: 14px;
      background: white; font-size: 24px; font-weight: 600; color: var(--text);
      cursor: pointer; transition: all 0.12s;
    }
    .pin-key:active { background: var(--bg); transform: scale(0.95); }
    .pin-key.del { font-size: 20px; color: var(--sub); }
    .pin-error { color: #EF4444; font-size: 14px; margin-top: 12px; min-height: 20px; }

    /* ===== å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  ===== */
    .form-wrap { width: 100%; max-width: 520px; }
    .form-field { margin-bottom: 20px; }
    .form-label { font-size: 14px; font-weight: 600; color: var(--sub); margin-bottom: 8px; display: block; }
    .form-input {
      width: 100%; padding: 16px 18px;
      border: 2px solid var(--border); border-radius: 12px;
      font-size: 18px; color: var(--text); background: white;
    }
    .form-input:focus { outline: none; border-color: var(--green); }
    .form-submit {
      width: 100%; padding: 20px;
      background: var(--green); color: white;
      border: none; border-radius: 14px;
      font-size: 18px; font-weight: 700;
      cursor: pointer; margin-top: 8px;
    }
    .form-submit:active { background: var(--green-dark); }
    .form-submit:disabled { opacity: 0.5; cursor: default; }

    /* ===== é€ä¿¡ä¸­ ===== */
    .spinner {
      width: 56px; height: 56px;
      border: 5px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .sending-text { font-size: 18px; color: var(--sub); }

    /* ===== å®Œäº† ===== */
    .done-icon  { font-size: 88px; margin-bottom: 24px; }
    .done-title { font-size: 30px; font-weight: 700; color: var(--text); margin-bottom: 14px; text-align: center; }
    .done-sub   { font-size: 18px; color: var(--sub); text-align: center; line-height: 1.7; margin-bottom: 36px; }
    .countdown  {
      font-size: 15px; color: var(--sub);
      background: white; border-radius: 100px;
      padding: 10px 28px;
      border: 2px solid var(--border);
    }

    /* ===== è¨­å®šç”»é¢ ===== */
    .settings-wrap { width: 100%; max-width: 520px; }
    .settings-title { font-size: 26px; font-weight: 700; color: var(--text); margin-bottom: 28px; }
    .field-label { font-size: 13px; font-weight: 600; color: var(--sub); margin-bottom: 6px; margin-top: 18px; }
    .field-input {
      width: 100%; padding: 14px 16px;
      border: 2px solid var(--border); border-radius: 12px;
      font-size: 15px; color: var(--text); background: white;
    }
    .field-input:focus { outline: none; border-color: var(--primary); }
    textarea.field-input { resize: vertical; min-height: 120px; }
    .save-btn {
      width: 100%; padding: 18px;
      background: var(--primary); color: white;
      border: none; border-radius: 14px;
      font-size: 17px; font-weight: 700;
      cursor: pointer; margin-top: 24px;
    }
    .save-btn:active { background: var(--primary-dark); }
    .settings-note { font-size: 12px; color: var(--sub); margin-top: 12px; text-align: center; line-height: 1.6; }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œï¼ˆè¨­å®šç”»é¢ã®ã¿ï¼‰ */
    #page-settings { overflow-y: auto; justify-content: flex-start; padding-top: 100px; }
  </style>
</head>
<body>

<!-- ===== ãƒ›ãƒ¼ãƒ  ===== -->
<div id="page-home" class="page active">
  <div class="home-header">
    <img class="logo-img" src="logo.png" alt="eSTACK ãƒ­ã‚´">
    <div class="logo-name">eSTACKæ ªå¼ä¼šç¤¾</div>
  </div>
  <div class="welcome">ã‚ˆã†ã“ãã€‚ã”ç”¨ä»¶ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</div>

  <button class="main-btn btn-delivery" onclick="goPage('page-delivery')">
    <span class="btn-icon">ğŸ“¦</span>
    <div>
      <div class="btn-title">è·ç‰©ã®å—ã‘æ¸¡ã—</div>
      <div class="btn-desc">é…é€æ¥­è€…ã®æ–¹ã¯ã“ã¡ã‚‰</div>
    </div>
  </button>

  <button class="main-btn btn-visitor" onclick="goPage('page-visitor')">
    <span class="btn-icon">ğŸ‘¤</span>
    <div>
      <div class="btn-title">æ¥å®¢ãƒ»ãŠæ‰“ã¡åˆã‚ã›</div>
      <div class="btn-desc">ã”æ¥è¨ªã®æ–¹ã¯ã“ã¡ã‚‰</div>
    </div>
  </button>

  <button class="settings-btn" onclick="openPinLock()" title="è¨­å®š">âš™ï¸</button>
</div>

<!-- ===== é…é€æ¥­è€…é¸æŠ ===== -->
<div id="page-delivery" class="page">
  <button class="back-btn" onclick="goPage('page-home')">â†</button>
  <div class="page-title">é…é€æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
  <div class="page-desc">ã”åˆ©ç”¨ã®é…é€æ¥­è€…ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>

  <button class="sub-btn" onclick="notifyDelivery('ãƒ¤ãƒãƒˆé‹è¼¸')">
    <span class="si">ğŸ±</span> ãƒ¤ãƒãƒˆé‹è¼¸
  </button>
  <button class="sub-btn" onclick="notifyDelivery('ä½å·æ€¥ä¾¿')">
    <span class="si">ğŸšš</span> ä½å·æ€¥ä¾¿
  </button>
  <button class="sub-btn" onclick="notifyDelivery('æ—¥æœ¬éƒµä¾¿')">
    <span class="si">âœ‰ï¸</span> æ—¥æœ¬éƒµä¾¿
  </button>
  <button class="sub-btn" onclick="notifyDelivery('ãã®ä»–')">
    <span class="si">ğŸ“®</span> ãã®ä»–
  </button>
</div>

<!-- ===== æ¥å®¢ï¼šæ‹…å½“è€…é¸æŠ ===== -->
<div id="page-visitor" class="page">
  <button class="back-btn" onclick="goPage('page-home')">â†</button>
  <div class="page-title">æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
  <div class="page-desc">ã”ç”¨ä»¶ã®æ‹…å½“è€…ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>
  <div id="staff-list"></div>
</div>

<!-- ===== PINãƒ­ãƒƒã‚¯ ===== -->
<div id="page-pin" class="page">
  <button class="back-btn" onclick="goPage('page-home')">â†</button>
  <div class="pin-wrap">
    <div class="page-title">ğŸ”’ ç®¡ç†è€…PIN</div>
    <div class="page-desc">4æ¡ã®PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    <div class="pin-dots">
      <div class="pin-dot" id="dot-0"></div>
      <div class="pin-dot" id="dot-1"></div>
      <div class="pin-dot" id="dot-2"></div>
      <div class="pin-dot" id="dot-3"></div>
    </div>
    <div class="pin-pad">
      <button class="pin-key" onclick="pinInput('1')">1</button>
      <button class="pin-key" onclick="pinInput('2')">2</button>
      <button class="pin-key" onclick="pinInput('3')">3</button>
      <button class="pin-key" onclick="pinInput('4')">4</button>
      <button class="pin-key" onclick="pinInput('5')">5</button>
      <button class="pin-key" onclick="pinInput('6')">6</button>
      <button class="pin-key" onclick="pinInput('7')">7</button>
      <button class="pin-key" onclick="pinInput('8')">8</button>
      <button class="pin-key" onclick="pinInput('9')">9</button>
      <button class="pin-key" style="visibility:hidden"></button>
      <button class="pin-key" onclick="pinInput('0')">0</button>
      <button class="pin-key del" onclick="pinDelete()">âŒ«</button>
    </div>
    <div class="pin-error" id="pin-error"></div>
  </div>
</div>

<!-- ===== æ¥å®¢ï¼šä¼šç¤¾åãƒ»æ°åå…¥åŠ› ===== -->
<div id="page-visitor-form" class="page">
  <button class="back-btn" onclick="goPage('page-visitor')">â†</button>
  <div class="page-title">ãŠå®¢æ§˜æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
  <div class="page-desc">æ‹…å½“è€…ã¸ã®é€šçŸ¥ã«ä½¿ç”¨ã—ã¾ã™</div>
  <div class="form-wrap">
    <div class="form-field">
      <label class="form-label">ä¼šç¤¾åï¼ˆä»»æ„ï¼‰</label>
      <input class="form-input" id="visitor-company" type="text" placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡" />
    </div>
    <div class="form-field">
      <label class="form-label">ãŠåå‰ <span style="color:#EF4444">*</span></label>
      <input class="form-input" id="visitor-name" type="text" placeholder="å±±ç”° å¤ªéƒ" oninput="updateSubmitBtn()" />
    </div>
    <button class="form-submit" id="visitor-submit" onclick="submitVisitorForm()" disabled>é€šçŸ¥ã™ã‚‹</button>
  </div>
</div>

<!-- ===== é€ä¿¡ä¸­ ===== -->
<div id="page-sending" class="page">
  <div class="spinner"></div>
  <div class="sending-text">æ‹…å½“è€…ã«é€šçŸ¥ã—ã¦ã„ã¾ã™â€¦</div>
</div>

<!-- ===== å®Œäº† ===== -->
<div id="page-complete" class="page">
  <div class="done-icon" id="done-icon">âœ…</div>
  <div class="done-title" id="done-title">é€šçŸ¥ã—ã¾ã—ãŸï¼</div>
  <div class="done-sub" id="done-sub">æ‹…å½“è€…ãŒå‚ã‚Šã¾ã™ã€‚<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</div>
  <div class="countdown" id="countdown-label">10ç§’å¾Œã«ãƒˆãƒƒãƒ—ã¸æˆ»ã‚Šã¾ã™</div>
</div>

<!-- ===== è¨­å®š ===== -->
<div id="page-settings" class="page">
  <button class="back-btn" onclick="goPage('page-home')">â†</button>
  <div class="settings-wrap">
    <div class="settings-title">âš™ï¸ è¨­å®š</div>

    <div class="field-label">Slack Incoming Webhook URL</div>
    <input class="field-input" id="cfg-webhook" type="url"
      placeholder="https://hooks.slack.com/services/..." />

    <div class="field-label">ç®¡ç†è€…PINï¼ˆ4æ¡ï¼‰</div>
    <input class="field-input" id="cfg-pin" type="password" maxlength="4" placeholder="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼š1234" inputmode="numeric" />

    <div class="field-label" style="margin-top: 18px">Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨˜éŒ² URLï¼ˆGAS Webã‚¢ãƒ—ãƒª URLï¼‰</div>
    <input class="field-input" id="cfg-gas" type="url"
      placeholder="https://script.google.com/macros/s/..." />

    <div class="field-label" style="margin-top: 18px">ã‚¹ã‚¿ãƒƒãƒ•è¨­å®šï¼ˆ1è¡Œ1åï¼šåå‰,å½¹è·ï¼‰</div>
    <textarea class="field-input" id="cfg-staff"
      placeholder="ç«¹ç”°ã‚ˆã‚Šã¡ã‹,ä»£è¡¨å–ç· å½¹&#10;ç«¹å†…,ç·å‹™ãƒ»çµŒç†"></textarea>

    <button class="save-btn" onclick="saveSettings()">ä¿å­˜ã™ã‚‹</button>
    <div class="settings-note">
      Webhook URLã¯ Slack App ã® Incoming Webhooks ã§å–å¾—ã—ã¦ãã ã•ã„ã€‚<br>
      URLã‚’è¨­å®šã—ãªã„å ´åˆã¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆé€šçŸ¥ãªã—ï¼‰ã§å‹•ä½œã—ã¾ã™ã€‚
    </div>
  </div>
</div>

<script>
  // ===== URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— =====
  (function() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('wh')) localStorage.setItem('wh_url', decodeURIComponent(params.get('wh')));
    if (params.get('gas')) localStorage.setItem('gas_url', decodeURIComponent(params.get('gas')));
    if (params.get('pin')) localStorage.setItem('admin_pin', params.get('pin'));
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ã„çµ‚ã‚ã£ãŸã‚‰URLã‚’ã‚¯ãƒªãƒ¼ãƒ³
    if (params.has('wh') || params.has('gas') || params.has('pin')) {
      history.replaceState({}, '', window.location.pathname);
    }
  })();

  // ===== ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š =====
  const DEFAULT_STAFF = [
    { name: 'ç«¹ç”°ã‚ˆã‚Šã¡ã‹', role: 'ä»£è¡¨å–ç· å½¹' },
    { name: 'ç«¹å†…',         role: 'ç·å‹™ãƒ»çµŒç†' },
  ];

  const DEFAULT_PIN = '1234';

  function loadCfg() {
    return {
      webhook: localStorage.getItem('wh_url') || '',
      gas:     localStorage.getItem('gas_url') || '',
      pin:     localStorage.getItem('admin_pin') || DEFAULT_PIN,
      staff:   JSON.parse(localStorage.getItem('staff') || 'null') || DEFAULT_STAFF,
    };
  }

  function saveSettings() {
    const url  = document.getElementById('cfg-webhook').value.trim();
    const gas  = document.getElementById('cfg-gas').value.trim();
    const pin  = document.getElementById('cfg-pin').value.trim();
    const raw  = document.getElementById('cfg-staff').value.trim();
    const staff = raw.split('\n')
      .map(l => l.trim()).filter(Boolean)
      .map(l => { const [n, r] = l.split(','); return { name: n?.trim(), role: r?.trim() || '' }; })
      .filter(s => s.name);

    localStorage.setItem('wh_url', url);
    localStorage.setItem('gas_url', gas);
    if (pin && /^\d{4}$/.test(pin)) localStorage.setItem('admin_pin', pin);
    localStorage.setItem('staff', JSON.stringify(staff.length ? staff : DEFAULT_STAFF));
    renderStaff();
    alert('ä¿å­˜ã—ã¾ã—ãŸ âœ…');
  }

  // ===== ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆæç”» =====
  function renderStaff() {
    const { staff } = loadCfg();
    const el = document.getElementById('staff-list');
    el.innerHTML = '';

    staff.forEach(s => {
      const btn = document.createElement('button');
      btn.className = 'staff-btn';
      btn.innerHTML = `
        <div>
          <div class="staff-name">${s.name}</div>
          ${s.role ? `<div class="staff-role">${s.role}</div>` : ''}
        </div>
        <div class="staff-arrow">â†’</div>`;
      btn.onclick = () => openVisitorForm(s.name);
      el.appendChild(btn);
    });

    // ã€Œã©ãªãŸã§ã‚‚ã€ãƒœã‚¿ãƒ³
    const allBtn = document.createElement('button');
    allBtn.className = 'sub-btn';
    allBtn.style.maxWidth = '520px';
    allBtn.innerHTML = '<span class="si">ğŸ“¢</span> ã©ãªãŸã‹ã”å¯¾å¿œãã ã•ã„';
    allBtn.onclick = () => openVisitorForm('ã©ãªãŸã‹ã”å¯¾å¿œã„ãŸã ã‘ã‚‹æ–¹');
    el.appendChild(allBtn);
  }

  // ===== ãƒšãƒ¼ã‚¸é·ç§» =====
  function goPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    if (id === 'page-settings') {
      const c = loadCfg();
      document.getElementById('cfg-webhook').value = c.webhook;
      document.getElementById('cfg-gas').value     = c.gas;
      document.getElementById('cfg-pin').value     = '';
      document.getElementById('cfg-staff').value   = c.staff.map(s => `${s.name},${s.role}`).join('\n');
    }
  }

  // ===== Slack é€šçŸ¥ =====
  async function slackPost(text) {
    const { webhook } = loadCfg();
    if (!webhook) { console.log('[TEST MODE]', text); return; }
    try {
      await fetch(webhook, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text }),
        mode: 'no-cors',
      });
    } catch(e) { console.warn('Slacké€ä¿¡ã‚¨ãƒ©ãƒ¼:', e); }
  }

  // ===== PINãƒ­ãƒƒã‚¯ =====
  let _pinBuffer = '';
  function openPinLock() {
    _pinBuffer = '';
    updatePinDots();
    document.getElementById('pin-error').textContent = '';
    goPage('page-pin');
  }
  function pinInput(digit) {
    if (_pinBuffer.length >= 4) return;
    _pinBuffer += digit;
    updatePinDots();
    if (_pinBuffer.length === 4) {
      setTimeout(() => {
        const correct = loadCfg().pin;
        if (_pinBuffer === correct) {
          goPage('page-settings');
        } else {
          document.getElementById('pin-error').textContent = 'PINãŒé•ã„ã¾ã™';
          _pinBuffer = '';
          updatePinDots();
        }
      }, 120);
    }
  }
  function pinDelete() {
    _pinBuffer = _pinBuffer.slice(0, -1);
    updatePinDots();
    document.getElementById('pin-error').textContent = '';
  }
  function updatePinDots() {
    for (let i = 0; i < 4; i++) {
      document.getElementById(`dot-${i}`).classList.toggle('filled', i < _pinBuffer.length);
    }
  }

  // ===== ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨˜éŒ² =====
  async function recordToSheet(payload) {
    const { gas } = loadCfg();
    if (!gas) return;
    try {
      await fetch(gas, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        mode: 'no-cors',
      });
    } catch(e) { console.warn('ã‚·ãƒ¼ãƒˆè¨˜éŒ²å¤±æ•—:', e); }
  }

  // ===== æ¥å®¢ãƒ•ã‚©ãƒ¼ãƒ  =====
  let _staffTarget = '';
  function openVisitorForm(staffName) {
    _staffTarget = staffName;
    document.getElementById('visitor-company').value = '';
    document.getElementById('visitor-name').value = '';
    document.getElementById('visitor-submit').disabled = true;
    goPage('page-visitor-form');
  }
  function updateSubmitBtn() {
    const name = document.getElementById('visitor-name').value.trim();
    document.getElementById('visitor-submit').disabled = !name;
  }
  async function submitVisitorForm() {
    const company = document.getElementById('visitor-company').value.trim();
    const visitorName = document.getElementById('visitor-name').value.trim();
    if (!visitorName) return;
    await notifyVisitor(_staffTarget, visitorName, company);
  }

  function getDatetime() {
    const now = new Date();
    return `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  }

  async function notifyDelivery(company) {
    goPage('page-sending');
    const datetime = getDatetime();
    const msg = `ğŸ“¦ *é…é€æ¥­è€…ï¼ˆ${company}ï¼‰ã®æ–¹ãŒã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ã«ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã™ã€‚*\nâ€¢ æ—¥æ™‚ï¼š${datetime}\nè·ç‰©ã®å—ã‘æ¸¡ã—ã§ã™ã€‚ã”å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`;
    await Promise.all([
      slackPost(msg),
      recordToSheet({ datetime, type: 'é…é€', staff: '', company, visitor: '' })
    ]);
    showDone('ğŸ“¦', 'é€šçŸ¥ã—ã¾ã—ãŸï¼', 'æ‹…å½“è€…ãŒå‚ã‚Šã¾ã™ã€‚\nã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
  }

  async function notifyVisitor(staffName, visitorName, company) {
    goPage('page-sending');
    const datetime = getDatetime();
    const companyLine = company ? `\nâ€¢ ä¼šç¤¾åï¼š${company}` : '';
    const msg = `ğŸ‘¤ *æ¥å®¢ã®æ–¹ãŒã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ã«ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã™ã€‚*\nâ€¢ æ—¥æ™‚ï¼š${datetime}\nâ€¢ æ‹…å½“è€…ï¼š${staffName}${companyLine}\nâ€¢ è¨ªå•è€…ï¼š${visitorName} æ§˜\nã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ã¸ãŠè¶Šã—ãã ã•ã„ã€‚`;
    await Promise.all([
      slackPost(msg),
      recordToSheet({ datetime, type: 'æ¥å®¢', staff: staffName, company: company || '', visitor: visitorName })
    ]);
    showDone('ğŸ‘‹', 'é€šçŸ¥ã—ã¾ã—ãŸï¼', `${staffName} ã•ã‚“ã¸é€£çµ¡ã—ã¾ã—ãŸã€‚\nã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚`);
  }

  // ===== å®Œäº†ï¼†ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ =====
  let timer = null;
  function showDone(icon, title, sub) {
    document.getElementById('done-icon').textContent  = icon;
    document.getElementById('done-title').textContent = title;
    document.getElementById('done-sub').innerHTML     = sub.replace(/\n/g, '<br>');
    goPage('page-complete');

    let sec = 10;
    document.getElementById('countdown-label').textContent = `${sec}ç§’å¾Œã«ãƒˆãƒƒãƒ—ã¸æˆ»ã‚Šã¾ã™`;
    if (timer) clearInterval(timer);
    timer = setInterval(() => {
      sec--;
      document.getElementById('countdown-label').textContent = `${sec}ç§’å¾Œã«ãƒˆãƒƒãƒ—ã¸æˆ»ã‚Šã¾ã™`;
      if (sec <= 0) { clearInterval(timer); goPage('page-home'); }
    }, 1000);
  }

  // ===== åˆæœŸåŒ– =====
  renderStaff();
</script>
</body>
</html>
